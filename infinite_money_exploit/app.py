from flask import Flask, request, render_template, session
import os

app = Flask(__name__, template_folder="templates", static_folder="static")
app.secret_key = "pharaohs_bank_secret"

FLAGS_DIR = "flags"
FLAG_FILE = os.path.join(FLAGS_DIR, "golden_sands_of_atum.txt")

# Skapa flaggan om den saknas
os.makedirs(FLAGS_DIR, exist_ok=True)
if not os.path.exists(FLAG_FILE):
    with open(FLAG_FILE, "w", encoding="utf-8") as f:
        f.write("O24{golden_sands_of_atum_create_wealth_without_end}")

# 💰 Infinite Money Exploit - Bank Transfer
@app.route("/")
def index():
    return render_template("index.html")

@app.route("/bank", methods=["GET"])
def bank():
    hint = None
    if request.args.get("hint"):
        hint = "The gods' ledgers have a weakness... what happens if you take instead of give?"
    return render_template("bank.html", hint=hint)

@app.route("/bank/transfer", methods=["POST"])
def bank_transfer():
    amount = request.form.get("amount", "0")
    try:
        amount = int(amount)
        if amount < 0:
            session["infinite_money_exploit"] = True  # 🔓 Markera utmaningen som avklarad
            with open(FLAG_FILE, "r", encoding="utf-8") as f:
                flag = f.read().strip()
            return render_template("bank.html", message=f"🏆 You exploited the banking system! Flag: {flag}")
        return render_template("bank.html", message=f"✅ Transaction successful! You transferred {amount} coins.")
    except ValueError:
        return render_template("bank.html", message="❌ Transaction failed. Invalid amount!")

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)