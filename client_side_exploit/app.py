from flask import Flask, request, render_template, session
import os

app = Flask(__name__, template_folder="templates", static_folder="static")
app.secret_key = "indiana_jones_secret"

FLAGS_DIR = "flags"
FLAG_FILE = os.path.join(FLAGS_DIR, "market_of_hatshepsut.txt")

# Skapa flaggfilerna om de saknas
os.makedirs(FLAGS_DIR, exist_ok=True)
if not os.path.exists(FLAG_FILE):
    with open(FLAG_FILE, "w") as f:
        f.write("O24{market_of_hatshepsut_welcomes_the_shadow_trader}")

# 📜 Startside
@app.route("/")
def index():
    return render_template("index.html")

# 📜 Client-Side Exploit
@app.route("/store", methods=["GET"])
def store():
    hint = None
    if request.args.get("hint"):
        hint = "Merchants don’t verify prices... but where do they store them?"
    return render_template("store.html", hint=hint)

@app.route("/store/buy", methods=["POST"])
def store_buy():
    price = request.form.get("price", "100")
    try:
        price = int(price)
        if price < 0:
            session["client_side_exploit"] = True  # 🔓 Markera utmaningen som avklarad
            with open(FLAG_FILE, "r") as f:
                flag = f.read().strip()
            return render_template("store.html", message=f"🏆 You exploited the system! Flag: {flag}")
        return render_template("store.html", message=f"✅ You bought an item for {price}!")
    except ValueError:
        return render_template("store.html", message="❌ Transaction failed. Invalid input!")

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
